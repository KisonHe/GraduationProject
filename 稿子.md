1. 老师们好。我的题目是基于ESP32的物流节点设计。（看看别人怎么说的）（老师们辛苦了？）
2. 我的PPT内容主要分为选题背景与意义，主要工作内容，不足与展望和总结致谢。
3. 首先介绍选题背景与意义
4. 国务院发布的《国务院办公厅关于进一步推进物流降本增效 促进实体经济发展的意见》中有要求大力推进物联网等信息技术在物流服务中的应用。目前我国许多的物流控制系统仍然是有线方案。有线控制有很多不便，如扩展和结构调整麻烦等。
5. 目前，已经有人提出了基于ZigBee的无线方案，但Zigbee也有自身缺陷，如Zigbee的16位地址最大容纳不到65535个节点，传输速率也低，存在改进空间。
6. 综合现状与背景调查，可以整理需求。一，需要实现无线组网，并且所选协议可靠简便，可扩展性高。二，组网完成后的通信协议能方便的与物流控制系统进行通信，回报电机数据，被物流系统控制。此外，作为物流控制节点，常常有传感器数据需要回报，因此节点需要可以回报给物流系统一些传感器的值。三，需要能够路程/速度闭环控制电机。四，人员能够方便的现场查看与调试电机、网络。
7. 接下来介绍主要工作内容
8. 由需求可以定义出系统的功能模块，分为图中的这些功能模块。
9. 由功能模块可以大致设计出系统的组成，分为图中的这些模块，软件开发上使用VSCode+Platformio平台开发，利用C++与设计模式，对软件进行优化，方便接入更多功能。
10. 总体结果上，实现了所有的需求点。完成PCB设计与制作，能够对电机进行路程/速度的闭环控制。现场人员能够通过触摸屏、手机网页对电机进行控制。为了验证被系统控制的可行性，自行编写了物流系统的模拟程序，可以读取电机的各种值，并对电机进行控制。并对嵌入式软件进行了多种优化，如Wi-Fi断联自动重建http与mqtt连接，中文显示启用超分辨率增加可读性，使用NVS存储触摸校准数据等等。
11. 本设计软件上留出了接口，可以方便的进行修改。ESP32支持多分区OTA更新，使得固件更新并不困难。
12. 现在简要介绍一下为什么选择ESP32。ESP32是我国乐鑫公司生产的，不仅在行业广泛使用，同时在各种创客社区也有大量使用的爆款单片机，拥有所示的多种强大优点，对比其他同类产品开发简单，价格低廉，性能强劲。
13. M3508减速电机套是深圳大疆公司研制的一款电机。配备大疆创新公司定制的FOC电调，可以广泛应用于机器人移动平台动力、驱动模块等机构中。M3508电机配套的C620电调可以使用CAN总线进行控制，CAN总线非常稳定，这种控制方式也让控制多个电机不成问题。满足本设计的要求，极大的简化了MCU端的电路与软件设计，非常适合本设计。由于软件有充分的解偶性，使用C++开发。如果用户希望更换电机，仅需更换极少的驱动代码即可。
14. 这是PCB硬件的原理图
15. 以及布线和PCB实物
16. MQTT是物联网行业广泛使用的一种通信协议。MQTT使用订阅发布机制，因此需要中心通信节点。为了方便使用，在阿里云上搭建了MQTT中转服务器。
17. 首先演示触摸屏。开发人员可以使用触摸屏查看各种信息。先来看网络部分，可以显示信号强度，IP地址，连接的AP的名字与BSSID,对网络查找问题很有帮助。还可以查看通过板上预留的SPI、串口、I2C等接口连接的传感器值。可以控制电机，这里设置转速为1500,可以看到信息界面显示了运行态为速度闭环。还可以设置为路程闭环，这里设置目标路程为320,可以看到电机迅速转到目标位置并停下。设置路程为3320度，可以看到用手去迫使电机偏移，电机会自动回到设定的的位置。现场人员的安全最重要，一旦设定为安全模式，会无视任何指令，将电机的扭矩设置为零。
18. 接下来演示模拟物流控制系统。首先登陆到物流控制系统，模拟物流控制系统的主界面，支持命令自动补全。最下面一栏显示了被控制的节点ID,对应的详细信息，包括转速、路程、PID参数、传感器信息等。接下来设置转速为 1000,可以看到电机开始起转，并且屏幕正确显示了对应的信息。然后演示设置不同的速度。接下来演示设置路程闭环，设置 路程 为 3000,可以看到电机改为路程闭环运行，并且迅速的到达目标位置。演示设置 路程 为 0。接下来设置一个远一点的路程 为 -10000，可以看到电机以最高速度快速到达目标位置。还可以设置PID参数，设置外环 kP 为 0.2，可以在嵌入式屏幕以及最下栏看到更新，设置内环 kP 为 20，可以在嵌入式屏幕看到更新，最下栏显示空间不足未显示，设置内环 kI 为 0.2，可以在嵌入式屏幕看到更新，设置外环 kP 为 0.1，最后退出模拟物流控制系统
19. 接下来演示手机控制界面，连接到网页后，现场人员可以查看一些系统基本信息。可以选择不同的控制方式，可以看到嵌入式屏幕有所更新。接下来设置速度，可以看到电机起转，屏幕有所更新。设置不同的转速。接下来演示路程控制，可以看到电机改为路程闭环运行，并且迅速的到达目标位置。还可以改变内环PID参数的值，可以看到屏幕有所更新。
20. HTTP的代码体积较大，尝试精简之后仍有627k,尽管ESP32有16MB的Flash空间，但节约一些总是好的。因此，将网页放在SPIFFS中而不是代码段中。这样OTA软件便可以精简体积。同时使用gzip对网页进行压缩，进一步减少网页文件体积。可以看到压缩后的文件大小仅为源文件的24%。
21. 电阻式触摸屏需要校准，不同的屏幕校准值不同。校准值写死在程序段中会导致量产不便。因此，使用NVS存储，自动判断是否需要校准，接下来演示该过程。利用串口日志揭示系统中发生了什么。
22. 全新的单片机启动后，会发现NVS存储中没有校准数据，开始校准过程。校准完成后，系统会启动。这里我们复位一下ESP32，可以看到启动完成了校准数据的读取。
23. 为了效果更好的显示中文，使用抗锯齿与亚像素渲染。现代的个人设备几乎没有不使用这两个技术的，但是嵌入式设备上普及率不高。抗锯齿就是利用灰度营造平滑的感觉，亚像素就是利用屏幕的像素排列减少锯齿感。
24. 工业环境要求高，因此WiFi连接丢失后必须尽快重连并且重新建立MQTT的控制连接。这里通过拔掉路由器电源模拟Wi-Fi丢失，可以看到插上电源后自动重连。
25. 由于时间以及个人能力有限，在本设计中还有很多可以改进的地方。可以换用ESP32-S3。ESP32的勘误表中有许多关于CAN的硬件问题，有的可以通过软件规避，有的不可以。ESP32S3是乐鑫最新的单片机之一，修正了大量ESP32的问题，可以外带更多Flash,更多PSRAM,甚至片内集成了JTag调试器，无需额外购买调试设备。是行业的领先方案。还应该留出PCB的固定孔，方便PCB的固定。还可以换电容屏，触摸更精确，体验更好。
26. 感谢各位老师的聆听，还请各位老师批评指正
